<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Français Master Pro | 法语数字终极听写</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .input-char-correct { color: #10B981; font-weight: bold; }
        .input-char-wrong { color: #EF4444; text-decoration: underline; font-weight: bold; }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4">

    <!-- 主卡片 -->
    <div class="glass-panel w-full max-w-lg rounded-3xl p-8 relative overflow-hidden transition-all duration-300 mb-8 mt-4">
        
        <!-- 顶部标题区 -->
        <div class="flex justify-between items-end mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">
                    <i class="fa-solid fa-headphones text-indigo-500 mr-2"></i>Français
                </h1>
                <p class="text-xs text-slate-400 mt-1">数字听写特训 0-100</p>
            </div>
            
            <!-- 随机模式下的进度 -->
            <div id="random-status" class="hidden text-right">
                <div class="text-xs text-slate-500 mb-1">本组进度</div>
                <div class="text-lg font-bold text-indigo-600">
                    <span id="queue-current">0</span> / <span id="queue-total">0</span>
                </div>
            </div>
        </div>

        <!-- 进度条 (仅随机模式) -->
        <div id="progress-container" class="hidden w-full bg-gray-200 rounded-full h-2 mb-6 overflow-hidden">
            <div id="progress-fill" class="progress-bar-fill bg-indigo-500 h-2 rounded-full" style="width: 0%"></div>
        </div>

        <!-- 设置与模式控制 -->
        <div class="bg-white/60 border border-white/50 p-4 rounded-2xl mb-6 shadow-sm">
            <!-- 模式切换按钮 -->
            <div class="flex justify-center mb-4 bg-slate-100 p-1 rounded-xl">
                <button onclick="switchMode('seq')" id="btn-seq" class="flex-1 py-2 text-sm rounded-lg font-medium transition-all shadow-sm bg-white text-indigo-600">顺序闯关</button>
                <button onclick="switchMode('rand')" id="btn-rand" class="flex-1 py-2 text-sm rounded-lg font-medium transition-all text-slate-500 hover:text-slate-700">随机抽查</button>
            </div>

            <!-- 顺序模式设置 -->
            <div id="seq-settings" class="transition-all duration-300">
                <div class="flex items-center gap-2 text-sm text-slate-600">
                    <span class="font-medium whitespace-nowrap">从第</span>
                    <input type="number" id="seq-start-num" value="0" min="0" max="100" class="w-16 p-1.5 text-center bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none font-bold text-indigo-600">
                    <span class="font-medium whitespace-nowrap">开始 (到 100)</span>
                    <button onclick="applySeqStart()" class="ml-auto text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 font-medium active:scale-95 transition-transform">
                        <i class="fa-solid fa-play mr-1"></i>跳转/开始
                    </button>
                </div>
            </div>

            <!-- 随机模式设置 (默认隐藏) -->
            <div id="rand-settings" class="hidden transition-all duration-300">
                <div class="flex items-center gap-2 text-sm text-slate-600">
                    <span class="font-medium">范围:</span>
                    <input type="number" id="range-min" value="0" min="0" max="100" class="w-14 p-1.5 text-center bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
                    <span>-</span>
                    <input type="number" id="range-max" value="100" min="0" max="100" class="w-14 p-1.5 text-center bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
                    <button onclick="initRandomMode()" class="ml-auto text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 font-medium active:scale-95 transition-transform">
                        <i class="fa-solid fa-shuffle mr-1"></i>生成新题
                    </button>
                </div>
            </div>
        </div>

        <!-- 听写互动区 -->
        <div class="text-center mb-8 relative">
            <!-- 音频开关 -->
            <div class="absolute right-0 top-0 flex flex-col items-center z-10">
                <button id="audio-toggle" onclick="toggleAudio()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm border bg-indigo-100 border-indigo-200 text-indigo-600 mb-1" title="自动发音开关">
                    <i id="audio-icon" class="fa-solid fa-volume-high"></i>
                </button>
                <span class="text-[10px] text-slate-400 font-medium">Auto</span>
            </div>

            <!-- 数字显示 (点击也可发音) -->
            <div class="mb-4 h-24 flex items-center justify-center group cursor-pointer" onclick="manualSpeak()" title="点击手动发音">
                <span id="number-display" class="text-7xl font-bold text-slate-800 tracking-tighter select-none transition-transform group-hover:scale-110 active:scale-95">?</span>
            </div>

            <p class="text-slate-400 text-sm mb-6 font-medium">Type the French number</p>

            <!-- 输入框 -->
            <div class="relative">
                <input type="text" id="user-input" autocomplete="off" 
                    class="w-full text-center text-xl p-4 bg-white border-2 border-slate-200 rounded-2xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all font-medium text-slate-700 placeholder-slate-300 shadow-inner"
                    placeholder="在此输入..." onkeydown="handleEnter(event)">
                
                <!-- 错误反馈 -->
                <div id="feedback" class="mt-3 h-6 text-sm font-medium transition-all opacity-0"></div>
            </div>
        </div>

        <!-- 辅助键盘 -->
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="addChar('é')" class="btn-char">é</button>
            <button onclick="addChar('è')" class="btn-char">è</button>
            <button onclick="addChar('à')" class="btn-char">à</button>
            <button onclick="addChar('ç')" class="btn-char">ç</button>
            <button onclick="addChar('-')" class="btn-char w-12">-</button>
        </div>

        <!-- 提交按钮 -->
        <button onclick="checkAnswer()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span>Valider</span> <i class="fa-solid fa-check"></i>
        </button>
    </div>

    <!-- 错题本 (Mistake Log) -->
    <div class="w-full max-w-lg">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-700"><i class="fa-solid fa-triangle-exclamation text-red-400 mr-2"></i>错题记录</h3>
                <button onclick="clearMistakes()" class="text-xs text-slate-400 hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-trash-can mr-1"></i>清空
                </button>
            </div>
            
            <div class="p-0">
                <div id="empty-log-msg" class="text-center py-8 text-slate-400 text-sm">
                    暂无错题，继续保持！<br>
                    <span class="text-xs opacity-70">Bravo! Pas d'erreurs.</span>
                </div>

                <!-- 错题列表容器 -->
                <ul id="mistake-list" class="divide-y divide-slate-100 hidden max-h-60 overflow-y-auto">
                    <!-- 动态生成错题 -->
                </ul>
            </div>
        </div>
    </div>

    <!-- 完成弹窗 -->
    <div id="finish-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 text-center shadow-2xl animate-[bounce_0.5s_ease-out]">
            <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <i class="fa-solid fa-trophy"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Excellent !</h2>
            <p class="text-gray-500 mb-6">当前任务已全部完成。</p>
            <button onclick="closeModalAndReset()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition">Commencer une nouvelle série</button>
        </div>
    </div>

<style>
    .btn-char {
        @apply w-10 h-10 bg-white border-2 border-slate-200 rounded-xl shadow-sm hover:bg-slate-50 hover:border-indigo-400 hover:text-indigo-600 text-slate-600 font-bold text-lg transition-all active:bg-indigo-50 active:scale-90;
    }
    
    /* 自定义滚动条 */
    #mistake-list::-webkit-scrollbar { width: 6px; }
    #mistake-list::-webkit-scrollbar-track { background: #f1f1f1; }
    #mistake-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
</style>

<script>
    // === 数据源 (0-100) ===
    const frenchNumbers = [
        "zéro", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf", "dix",
        "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf", "vingt",
        "vingt et un", "vingt-deux", "vingt-trois", "vingt-quatre", "vingt-cinq", "vingt-six", "vingt-sept", "vingt-huit", "vingt-neuf", "trente",
        "trente et un", "trente-deux", "trente-trois", "trente-quatre", "trente-cinq", "trente-six", "trente-sept", "trente-huit", "trente-neuf", "quarante",
        "quarante et un", "quarante-deux", "quarante-trois", "quarante-quatre", "quarante-cinq", "quarante-six", "quarante-sept", "quarante-huit", "quarante-neuf", "cinquante",
        "cinquante et un", "cinquante-deux", "cinquante-trois", "cinquante-quatre", "cinquante-cinq", "cinquante-six", "cinquante-sept", "cinquante-huit", "cinquante-neuf", "soixante",
        "soixante et un", "soixante-deux", "soixante-trois", "soixante-quatre", "soixante-cinq", "soixante-six", "soixante-sept", "soixante-huit", "soixante-neuf", "soixante-dix",
        "soixante et onze", "soixante-douze", "soixante-treize", "soixante-quatorze", "soixante-quinze", "soixante-seize", "soixante-dix-sept", "soixante-dix-huit", "soixante-dix-neuf", "quatre-vingts",
        "quatre-vingt-un", "quatre-vingt-deux", "quatre-vingt-trois", "quatre-vingt-quatre", "quatre-vingt-cinq", "quatre-vingt-six", "quatre-vingt-sept", "quatre-vingt-huit", "quatre-vingt-neuf", "quatre-vingt-dix",
        "quatre-vingt-onze", "quatre-vingt-douze", "quatre-vingt-treize", "quatre-vingt-quatorze", "quatre-vingt-quinze", "quatre-vingt-seize", "quatre-vingt-dix-sept", "quatre-vingt-dix-huit", "quatre-vingt-dix-neuf", "cent"
    ];

    // === 状态管理 ===
    let state = {
        mode: 'seq', // 'seq' | 'rand'
        currentIndex: 0,
        targetNumber: 0,
        isAudioOn: true,
        // 随机模式专用
        queue: [],
        totalInBatch: 0,
        completedInBatch: 0,
        // 错题记录 { number: count }
        mistakes: {} 
    };

    window.onload = () => {
        loadQuestion();
    };

    // === 模式切换与UI控制 ===
    function switchMode(mode) {
        state.mode = mode;
        const btnSeq = document.getElementById('btn-seq');
        const btnRand = document.getElementById('btn-rand');
        const seqSettings = document.getElementById('seq-settings');
        const randSettings = document.getElementById('rand-settings');
        
        const randomStatus = document.getElementById('random-status');
        const progressContainer = document.getElementById('progress-container');

        if (mode === 'seq') {
            btnSeq.className = "flex-1 py-2 text-sm rounded-lg font-medium transition-all shadow-sm bg-white text-indigo-600";
            btnRand.className = "flex-1 py-2 text-sm rounded-lg font-medium transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-50";
            seqSettings.classList.remove('hidden');
            randSettings.classList.add('hidden');
            randomStatus.classList.add('hidden');
            progressContainer.classList.add('hidden');
            
            // 切换回顺序模式时，根据输入框重置
            applySeqStart(); 
        } else {
            btnRand.className = "flex-1 py-2 text-sm rounded-lg font-medium transition-all shadow-sm bg-white text-indigo-600";
            btnSeq.className = "flex-1 py-2 text-sm rounded-lg font-medium transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-50";
            seqSettings.classList.add('hidden');
            randSettings.classList.remove('hidden');
            randomStatus.classList.remove('hidden');
            progressContainer.classList.remove('hidden');

            initRandomMode();
        }
    }

    // === 顺序模式逻辑 ===
    function applySeqStart() {
        let startVal = parseInt(document.getElementById('seq-start-num').value);
        if (isNaN(startVal) || startVal < 0) startVal = 0;
        if (startVal > 100) startVal = 100;
        
        document.getElementById('seq-start-num').value = startVal;
        state.currentIndex = startVal;
        
        // 如果是顺序模式，立即加载
        if (state.mode === 'seq') {
            loadQuestion();
        }
    }

    // === 随机模式逻辑 ===
    function initRandomMode() {
        let min = parseInt(document.getElementById('range-min').value);
        let max = parseInt(document.getElementById('range-max').value);
        
        if (isNaN(min)) min = 0; if (isNaN(max)) max = 100;
        if (min < 0) min = 0; if (max > 100) max = 100;
        if (min > max) [min, max] = [max, min];
        
        document.getElementById('range-min').value = min;
        document.getElementById('range-max').value = max;

        let arr = [];
        for (let i = min; i <= max; i++) arr.push(i);

        // 洗牌
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }

        state.queue = arr;
        state.totalInBatch = arr.length;
        state.completedInBatch = 0;

        updateProgressUI();
        loadNextRandom();
    }

    function loadNextRandom() {
        if (state.queue.length === 0) {
            showFinishModal();
            return;
        }
        state.targetNumber = state.queue.pop();
        renderScreen();
    }

    // === 核心加载与渲染 ===
    function loadQuestion() {
        if (state.mode === 'seq') {
            state.targetNumber = state.currentIndex;
            if (state.targetNumber > 100) {
                showFinishModal(); // 顺序模式到100也弹窗
                return;
            }
            renderScreen();
        } 
        // 随机模式由 initRandomMode 或 checkAnswer 触发 loadNextRandom
    }

    function renderScreen() {
        const input = document.getElementById('user-input');
        input.value = '';
        input.className = "w-full text-center text-xl p-4 bg-white border-2 border-slate-200 rounded-2xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all font-medium text-slate-700 placeholder-slate-300 shadow-inner";
        
        const feedback = document.getElementById('feedback');
        feedback.innerHTML = '';
        feedback.classList.remove('opacity-100');

        document.getElementById('number-display').innerText = state.targetNumber;
        input.focus();

        if (state.isAudioOn) {
            setTimeout(() => speakCurrent(), 300);
        }
    }

    // === 答题逻辑 ===
    function checkAnswer() {
        const userVal = document.getElementById('user-input').value.trim().toLowerCase();
        const correctVal = frenchNumbers[state.targetNumber];

        if (userVal === correctVal) {
            handleSuccess();
        } else {
            handleError(userVal, correctVal);
        }
    }

    function handleSuccess() {
        confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#818cf8', '#34d399'] });
        const feedback = document.getElementById('feedback');
        feedback.innerHTML = `<span class="text-green-500 font-bold"><i class="fa-solid fa-check mr-1"></i>Très bien !</span>`;
        feedback.classList.add('opacity-100');

        if (state.mode === 'rand') {
            state.completedInBatch++;
            updateProgressUI();
        }

        setTimeout(() => {
            if (state.mode === 'seq') {
                state.currentIndex++;
                loadQuestion();
            } else {
                loadNextRandom();
            }
        }, 1000);
    }

    function handleError(userVal, correctVal) {
        const input = document.getElementById('user-input');
        const feedback = document.getElementById('feedback');

        input.classList.remove('border-slate-200');
        input.classList.add('border-red-400', 'shake');
        setTimeout(() => input.classList.remove('shake'), 500);

        // 生成错误对比HTML
        let diffHtml = "";
        for (let i = 0; i < correctVal.length; i++) {
            if (userVal[i] === correctVal[i]) {
                diffHtml += `<span class="input-char-correct">${correctVal[i]}</span>`;
            } else {
                diffHtml += `<span class="input-char-wrong">${correctVal[i]}</span>`;
            }
        }

        feedback.innerHTML = `<span class="text-slate-500 text-xs">答案: </span>${diffHtml}`;
        feedback.classList.add('opacity-100');
        
        speakCurrent();
        recordMistake(state.targetNumber); // 记录错题
    }

    // === 错题本功能 ===
    function recordMistake(number) {
        // 增加计数
        if (!state.mistakes[number]) {
            state.mistakes[number] = 0;
        }
        state.mistakes[number]++;
        renderMistakeList();
    }

    function renderMistakeList() {
        const listEl = document.getElementById('mistake-list');
        const emptyMsg = document.getElementById('empty-log-msg');
        
        // 转换为数组并排序 (错误次数降序)
        const entries = Object.entries(state.mistakes)
            .map(([num, count]) => ({ num: parseInt(num), count }))
            .sort((a, b) => b.count - a.count);

        if (entries.length > 0) {
            emptyMsg.classList.add('hidden');
            listEl.classList.remove('hidden');
            
            listEl.innerHTML = entries.map(item => `
                <li class="px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <span class="w-8 h-8 rounded-lg bg-red-100 text-red-600 font-bold flex items-center justify-center text-sm">
                            ${item.num}
                        </span>
                        <span class="font-medium text-slate-700">${frenchNumbers[item.num]}</span>
                    </div>
                    <div class="flex items-center gap-1 text-xs text-red-500 font-semibold bg-red-50 px-2 py-1 rounded-full">
                        <i class="fa-solid fa-xmark"></i> ${item.count}
                    </div>
                </li>
            `).join('');
        } else {
            emptyMsg.classList.remove('hidden');
            listEl.classList.add('hidden');
        }
    }

    function clearMistakes() {
        if(confirm("确定清空错题记录吗？")) {
            state.mistakes = {};
            renderMistakeList();
        }
    }

    // === 其他辅助 ===
    function toggleAudio() {
        state.isAudioOn = !state.isAudioOn;
        const btn = document.getElementById('audio-toggle');
        const icon = document.getElementById('audio-icon');

        if (state.isAudioOn) {
            btn.className = "w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm border bg-indigo-100 border-indigo-200 text-indigo-600 mb-1";
            icon.className = "fa-solid fa-volume-high";
        } else {
            btn.className = "w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm border bg-slate-100 border-slate-200 text-slate-400 mb-1";
            icon.className = "fa-solid fa-volume-xmark";
        }
    }

    function manualSpeak() { speakCurrent(); }

    function speakCurrent() {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const text = frenchNumbers[state.targetNumber];
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR'; 
            utterance.rate = 0.9;
            const voices = window.speechSynthesis.getVoices();
            const frVoice = voices.find(v => v.lang === 'fr-FR');
            if (frVoice) utterance.voice = frVoice;
            window.speechSynthesis.speak(utterance);
        }
    }

    function updateProgressUI() {
        document.getElementById('queue-current').innerText = state.completedInBatch;
        document.getElementById('queue-total').innerText = state.totalInBatch;
        const percent = state.totalInBatch === 0 ? 0 : (state.completedInBatch / state.totalInBatch) * 100;
        document.getElementById('progress-fill').style.width = `${percent}%`;
    }

    function handleEnter(e) {
        if (e.key === 'Enter') checkAnswer();
    }
    function addChar(char) {
        const input = document.getElementById('user-input');
        input.value += char;
        input.focus();
    }
    function showFinishModal() {
        document.getElementById('finish-modal').classList.remove('hidden');
        confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 } });
    }
    function closeModalAndReset() {
        document.getElementById('finish-modal').classList.add('hidden');
        if(state.mode === 'rand') initRandomMode();
        else {
            state.currentIndex = 0;
            document.getElementById('seq-start-num').value = 0;
            loadQuestion();
        }
    }

    // 初始化
    toggleAudio(); toggleAudio();
</script>
</body>
</html>